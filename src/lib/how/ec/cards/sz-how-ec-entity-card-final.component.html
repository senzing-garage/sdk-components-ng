<div class="handle">
    <mat-icon fontIcon="arrow_right" *ngIf="!branchExpanded">arrow_right</mat-icon>
    <mat-icon fontIcon="arrow_left" *ngIf="branchExpanded">arrow_left</mat-icon>
</div>
<div class="content">
    <header>Entity <span class="entity-id">{{entityId}}</span></header>
    <mat-accordion class="steps-ribbon">
        <mat-expansion-panel (opened)="stepsPanelOpenState = true"
                    (closed)="stepsPanelOpenState = false">
            <mat-expansion-panel-header>
                <mat-panel-title>
                    Step #{{stepNumber}}: {{stepTitle}}
                </mat-panel-title>
            </mat-expansion-panel-header>
            <h4>On: <span class="feature-value">{{matchKey}}</span></h4>
            <h4>Using: <span class="feature-value">({{matchCodes}})</span></h4>
            <div class="steps-feat-scores">
                <h4>With Feature Scores:</h4>
                <div class="steps-feat-score" *ngFor="let fScoreBucket of featureScores | keyvalue">
                    <div *ngFor="let fScore of fScoreBucket.value">
                        {{fScore.featureType}} (Score {{fScore.score}})
                        <ul>
                            <li [attr.data-feature-id]="fScore.candidateFeature.featureId">{{fScore.candidateFeature.featureValue}}</li>
                            <li [attr.data-feature-id]="fScore.inboundFeature.featureId">{{fScore.inboundFeature.featureValue}}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </mat-expansion-panel>
    </mat-accordion>
    <mat-accordion class="features" multi>
        <mat-expansion-panel class="feature-drawer feature-drawer-sources" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Sources<span class="count-bubble">{{featureCount(sources)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let source of sources | keyvalue">
                    {{source.key}}<span class="count-bubble">{{featureCount(source.value)}}</span>:
                    <ul>
                        <li *ngFor="let record of source.value;">
                            {{record?.recordId}}
                        </li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-names" *ngIf="names" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Names<span class="count-bubble">{{featureCount(names)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of names">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-dob" *ngIf="dob" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Date of Birth<span class="count-bubble">{{featureCount(dob)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of dob">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-addresses" *ngIf="addresses" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Addresses<span class="count-bubble">{{featureCount(addresses)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of addresses">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-emails" *ngIf="emails" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Emails<span class="count-bubble">{{featureCount(emails)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of emails">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-phone-numbers" *ngIf="phoneNumbers" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Phone Numbers<span class="count-bubble">{{featureCount(phoneNumbers)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of phoneNumbers">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-ssn" *ngIf="ssnNumbers" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>SSN<span class="count-bubble">{{featureCount(ssnNumbers)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of ssnNumbers">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <mat-expansion-panel class="feature-drawer feature-drawer-drivers-licenses" *ngIf="dlNumbers" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>DL<span class="count-bubble">{{featureCount(dlNumbers)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of dlNumbers">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <!-- start "other features" -->
        <ng-container *ngIf="otherFeatures">
            <mat-expansion-panel class="feature-drawer feature-drawer-features" *ngFor="let otherFeat of otherFeatures | keyvalue" [expanded]="true" hideToggle>
                <mat-expansion-panel-header>{{otherFeat.key}}</mat-expansion-panel-header>
                <ul>
                    <li *ngFor="let feat of otherFeat.value">
                        {{feat}}
                    </li>
                </ul>
            </mat-expansion-panel>
        </ng-container>
        <!-- end "other features" -->
    </mat-accordion>
</div>