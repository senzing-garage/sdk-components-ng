<div class="handle" *ngIf="!singleton" [class.expanded]="branchExpanded" (click)="toggleSteps()">
    <mat-icon fontIcon="arrow_right">arrow_right</mat-icon>
    <!--<mat-icon fontIcon="arrow_left" *ngIf="branchExpanded" (click)="collapseSteps()">arrow_left</mat-icon>-->
</div>
<div class="content">
    <header>{{cardType}} <span class="entity-id">{{cardId}}</span></header>
    <div *ngIf="singleton" class="steps-header none">Singleton Entity</div>
    <mat-accordion #steps class="steps-ribbon" *ngIf="!singleton" >
        <mat-expansion-panel (opened)="stepsPanelOpenState = true"
                    (closed)="stepsPanelOpenState = false" hideToggle>
            <mat-expansion-panel-header>
                <mat-panel-title>
                    Step #{{stepNumber}}: {{stepTitle}}
                </mat-panel-title>
            </mat-expansion-panel-header>
            <h4>On: <span class="feature-value">{{matchKey}}</span></h4>
            <h4>Using: <span class="feature-value">({{matchCodes}})</span></h4>
            <div class="steps-feat-scores">
                <h4>With Feature Scores:</h4>
                <mat-radio-group aria-label="Select an option" [(ngModel)]="highlightedConstructionFeatureKey">
                    <div class="steps-feat-score" *ngFor="let fScoreBucket of featureScores | keyvalue" [class.highlighted]="isFeatureScoreBucketHighlighted(fScoreBucket.value)" [ngClass]="getHighlightedColorClasses(fScoreBucket.value)">
                        <mat-radio-button #button [value]="fScoreBucket.key" labelPosition="before" (click)="onFeatureScoreBucketClick($event, fScoreBucket.key, button)">
                        <div *ngFor="let fScore of fScoreBucket.value; let fScoreBucketIndex=index">
                            {{fScore.featureType}} (Score {{fScore.score}})
                            <ul>
                                <li [attr.data-feature-id]="fScore.candidateFeature.featureId">
                                    {{fScore.candidateFeature.featureValue}}
                                </li>
                                <li [attr.data-feature-id]="fScore.inboundFeature.featureId">{{fScore.inboundFeature.featureValue}}</li>
                            </ul>
                        </div>
                        </mat-radio-button>
                    </div>
                </mat-radio-group>
            </div>
        </mat-expansion-panel>
    </mat-accordion>
    <mat-accordion #features class="features" multi>
        <mat-expansion-panel class="feature-drawer feature-drawer-sources" [expanded]="true" hideToggle>
            <mat-expansion-panel-header>Sources<span class="count-bubble">{{featureCount(sources)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let source of sources | keyvalue">
                    {{source.key}}<span class="count-bubble">{{featureCount(source.value)}}</span>:
                    <ul>
                        <li *ngFor="let record of source.value | slice:0:recordLimit">
                            {{record?.recordId}}
                        </li>
                        <li *ngIf="source.value.length > recordLimit" class="more-link" (click)="onMoreLinkClick(source.key, $event)">more...</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <!-- start "other features" -->
        <mat-expansion-panel class="feature-drawer feature-drawer-features" [expanded]="true" hideToggle *ngFor="let featBucket of orderedFeatures">
            <mat-expansion-panel-header>{{featureName(featBucket.name)}}<span class="count-bubble">{{featureCount(featBucket.features)}}</span></mat-expansion-panel-header>
            <ul>
                <li *ngFor="let value of featBucket.features" [class.highlighted]="isFeatureValueInHighlightedItems(value)" [ngClass]="getHighlightedColorClassesForFeatureValue(value)">
                    {{value.primaryValue}}
                    <ul class="duplicate-tree" *ngIf="value.duplicateValues && value.duplicateValues.length > 0">
                        <li *ngFor="let dupVal of value.duplicateValues">{{dupVal}}</li>
                    </ul>
                </li>
            </ul>
        </mat-expansion-panel>
        <!-- end "other features" -->
    </mat-accordion>
</div>