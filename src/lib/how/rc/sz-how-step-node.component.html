<ul [class.tree]="isFinal" *ngIf="isFinal">
    <li class="top-level" *ngIf="isFinal">
        <sz-how-final-entity-card
        [attr.virtual-id]="data.resolvedVirtualEntityId"
        [data]="data"
        [featureOrder]="featureOrder"
        [virtualEntitiesById]="virtualEntitiesById"></sz-how-final-entity-card>
    </li>
    <li class="top-level-children">
        <ul class="hide-on-group-collapsed" *ngIf="hasChildren && !isStack">
            <li *ngFor="let step of children; let groupInd=index;">
                <sz-how-step-node
                [attr.step-index]="groupInd"
                [attr.step-number]="step.stepNumber"
                [attr.virtual-id]="step.resolvedVirtualEntityId"
                [data]="step"
                [featureOrder]="featureOrder" 
                [virtualEntitiesById]="virtualEntitiesById"></sz-how-step-node>
            </li>
        </ul>
    </li>
</ul>
<div *ngIf="!isFinal">
    <sz-how-step-card *ngIf="!isStack && !isFinal"
            [attr.step-number]="data.stepNumber"
            [attr.virtual-id]="data.resolvedVirtualEntityId"
            [data]="data"
            [featureOrder]="featureOrder" 
            [virtualEntitiesById]="virtualEntitiesById"
            ></sz-how-step-card>
    <sz-how-step-stack *ngIf="isStack"
    [attr.step-number]="data.stepNumber"
    [attr.virtual-id]="data.resolvedVirtualEntityId"
    [data]="dataAsNode"
    [featureOrder]="featureOrder" 
    [virtualEntitiesById]="virtualEntitiesById"
    ></sz-how-step-stack>
    <ul class="hide-on-group-collapsed" *ngIf="hasChildren && !isStack">
        <li *ngFor="let step of children; let groupInd=index;">
            <sz-how-step-node
            [attr.step-index]="groupInd"
            [attr.step-number]="step.stepNumber"
            [attr.virtual-id]="step.resolvedVirtualEntityId"
            [data]="step"
            [featureOrder]="featureOrder" 
            [virtualEntitiesById]="virtualEntitiesById"></sz-how-step-node>
        </li>
    </ul>
</div>